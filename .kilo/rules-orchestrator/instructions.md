# Orchestrator 模式详细规则

## 模型配置参考

### 可用模型列表

| 模型 ID | 用途 | 特点 |
|---------|------|------|
| `glm-5` | 复杂推理、架构设计、代码审查 | 最强推理能力 |
| `minimax/minimax-m2.5` | 代码实现、快速探索 | 高性价比 |
| `kimi-for-coding/k2.5` | 文档编写、测试设计 | 语言表达优秀 |

### 任务-模型映射决策树

```
任务开始
    │
    ├─ 是否涉及架构决策？
    │   └─ 是 → glm-5
    │
    ├─ 是否涉及安全审查？
    │   └─ 是 → glm-5
    │
    ├─ 是否是代码实现？
    │   └─ 是 → minimax/minimax-m2.5
    │
    ├─ 是否是文档/测试？
    │   └─ 是 → kimi-for-coding/k2.5
    │
    └─ 是否是快速探索？
        └─ 是 → minimax/minimax-m2.5
```

## 任务分解原则

### SMART 原则

每个子任务必须满足：
- **S**pecific - 具体明确
- **M**easurable - 可衡量
- **A**chievable - 可实现
- **R**elevant - 与目标相关
- **T**ime-bound - 有时间限制

### 任务粒度

- 单个子任务预计时间：15分钟 - 2小时
- 如果超过2小时，继续拆分
- 如果少于15分钟，考虑合并

### 依赖管理

```markdown
## 任务依赖图

Task A ──┬──> Task B ──> Task D
         │
         └──> Task C ──> Task E
                            │
                            └──> Task F (Final)
```

## 子代理调用模板

### 代码实现任务

```markdown
**委派给**: minimax/minimax-m2.5

**任务**: 实现 [功能名称]

**上下文**:
- 项目路径: /home/qujing/projects/ai-inference-managed-by-ai
- 相关文件:
  - pkg/unit/types.go (接口定义)
  - docs/ARCHITECTURE.md (架构文档)
- 依赖:
  - [已完成的依赖任务]

**要求**:
1. 遵循 AGENTS.md 中的代码规范
2. 实现完整的接口方法
3. 编写对应的单元测试

**期望输出**:
- 新增/修改的文件列表
- 测试运行结果
- 实现摘要
```

### 代码审查任务

```markdown
**委派给**: glm-5

**任务**: 审查 [功能名称] 的代码

**上下文**:
- 待审查文件:
  - [文件路径1]
  - [文件路径2]
- 审查标准:
  - 架构符合性 (docs/ARCHITECTURE.md)
  - 代码规范 (AGENTS.md)
  - 测试覆盖

**审查清单**:
- [ ] 代码符合架构设计
- [ ] 接口实现完整
- [ ] 错误处理正确
- [ ] 测试覆盖充分
- [ ] 命名规范一致
- [ ] 无安全漏洞

**期望输出**:
- 审查结果: 通过/需修改/退回
- 具体意见列表
```

### 文档编写任务

```markdown
**委派给**: kimi-for-coding/k2.5

**任务**: 编写 [文档名称]

**上下文**:
- 文档类型: API文档/用户指南/开发日志
- 目标读者: [读者群体]
- 相关代码: [代码路径]

**要求**:
1. 结构清晰，易于理解
2. 包含代码示例
3. 符合项目文档风格

**期望输出**:
- 文档文件路径
- 内容摘要
```

### 测试设计任务

```markdown
**委派给**: kimi-for-coding/k2.5

**任务**: 设计 [功能名称] 的测试用例

**上下文**:
- 被测功能: [功能描述]
- 相关代码: [代码路径]
- 测试类型: 单元测试/集成测试/E2E测试

**要求**:
1. 覆盖正常流程
2. 覆盖边界条件
3. 覆盖异常情况
4. 目标覆盖率: 70%+

**期望输出**:
- 测试用例列表
- 测试文件路径
```

## 进度跟踪

### 状态定义

| 状态 | 说明 | 可转换到 |
|------|------|----------|
| pending | 等待开始 | in_progress, cancelled |
| in_progress | 正在执行 | completed, blocked, pending |
| completed | 已完成 | - |
| blocked | 被阻塞 | pending, in_progress |
| cancelled | 已取消 | - |

### 日报格式

```markdown
# 📅 开发日报 - YYYY-MM-DD

## 今日完成
- [x] Task-001: 实现用户认证
- [x] Task-002: 编写认证测试

## 今日进行中
- [ ] Task-003: API 文档更新 (50%)

## 今日阻塞
- Task-004: 数据库迁移
  - 原因: 等待 Task-005 完成
  - 预计解除: 明天

## 明日计划
1. Task-004: 数据库迁移
2. Task-006: 性能优化

## 风险提示
- [如果有风险，在此列出]
```

## 异常处理

### 子代理失败

1. **第一次失败**
   - 分析失败原因
   - 调整任务描述
   - 重新委派

2. **第二次失败**
   - 考虑更换模型
   - 或进一步拆分任务
   - 重新委派

3. **第三次失败**
   - 标记为 blocked
   - 记录详细错误信息
   - 等待人工介入

### 上下文膨胀

当会话上下文超过 60%：
1. 立即使用 /compact 压缩
2. 将详细讨论移到 subagent
3. 只保留关键决策在主会话

## 质量检查点

### 功能完成后

- [ ] 代码已通过 go vet
- [ ] 代码已通过 go fmt
- [ ] 测试覆盖率达标
- [ ] 代码审查已通过
- [ ] 开发日志已创建
- [ ] Git 已提交

### 里程碑完成后

- [ ] 所有功能测试通过
- [ ] 集成测试通过
- [ ] 文档已更新
- [ ] 无已知 bug
- [ ] 代码审查全部通过
